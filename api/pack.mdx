---
title: "Pack"
description: "The Pack function compresses files for bundling"
---

## Overview

The `Pack` function compresses a set of files from disk for bundled use in the generated code. This function is only supposed to be called by the broccoli tool during code generation.

<Note>
  This function is internal to the broccoli tool and should not be called directly in application code.
</Note>

## Function Signature

```go
func Pack(files []*File, quality int) ([]byte, error)
```

## Parameters

<ParamField path="files" type="[]*File" required>
  A slice of File pointers representing the files to be compressed and packed. The files are automatically sorted by path before packing.
</ParamField>

<ParamField path="quality" type="int" required>
  The Brotli compression quality level (0-11). Higher values provide better compression but take longer:
  - `0-4`: Fast compression, lower ratio
  - `5-9`: Balanced compression
  - `10-11`: Maximum compression, slower
</ParamField>

## Return Values

<ResponseField name="[]byte" type="[]byte">
  The compressed bundle as a byte slice, which can be embedded in generated Go code.
</ResponseField>

<ResponseField name="error" type="error">
  Returns an error if compression or encoding fails.
</ResponseField>

## How It Works

1. **Sorting**: Files are sorted lexically by path to ensure deterministic output
2. **Parallel Compression**: Files are compressed in parallel using all available CPU cores
3. **GOB Encoding**: The compressed files are encoded using Go's gob encoding
4. **Bundle Compression**: The entire bundle is compressed again with Brotli

<Note>
  Pack uses `runtime.NumCPU()` to parallelize compression across all available CPU cores for optimal performance.
</Note>

## Implementation Details

```go
// Files are sorted lexically
sort.Slice(files, func(i, j int) bool {
    return files[i].Fpath < files[j].Fpath
})

// Parallel compression using worker pool
n := runtime.NumCPU()
feed := make(chan *File)
errs := make(chan error, n)

// Workers compress individual files
for i := 0; i < n; i++ {
    go func() {
        for f := range feed {
            data, err := f.compress(quality)
            if err != nil {
                errs <- err
                return
            }
            f.Data = data
        }
        errs <- nil
    }()
}
```

## Usage in Generated Code

The broccoli tool calls Pack during code generation:

```go
// Example generated code structure
package assets

import "aletheia.icu/broccoli/fs"

//go:embed generated by broccoli
var data = []byte{...}

var Assets = fs.New(false, data)
```

See the [New function](/api/new) documentation for how the packed bundle is unpacked at runtime.